---
name: Build APBS

on:
  pull_request:
  push:
    branches: [main]
    tags: ['*']

env:
  WIN_DEPENDENCIES_RELEASE: "v0.4.0"
  WIN_TOOLCHAIN_FILE: '/c/vcpkg/scripts/buildsystems/vcpkg.cmake'
  BLA_VENDOR: OpenBLAS
  BUILD_DOC: ON
  BUILD_SHARED_LIBS: OFF
  BUILD_TOOLS: ON
  RELEASE_TYPE: Release
  ENABLE_PYGBE: OFF
  ENABLE_BEM: ON
  ENABLE_GEOFLOW: ON
  ENABLE_FETK: ON
  FETK_VERSION: "1.8.1"
  ENABLE_iAPBS: ON
  ENABLE_OPENMP: ON
  ENABLE_PBAM: ON
  ENABLE_PBSAM: ON
  ENABLE_PYTHON: OFF
  ENABLE_TESTS: ON
  ENABLE_TINKER: OFF
  GIT_SUBMODULE: OFF
  GET_NanoShaper: ON

jobs:

  build:
    name: Compile Code

    runs-on: ${{ matrix.os }}

    if: "!contains(github.event.head_commit.message, 'noci')"

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macOS-latest, windows-latest]
        python-version: [3.9]

    outputs:
      apbs-version: ${{ steps.extract-version.outputs.apbs-version }}
      apbs-tag: ${{ steps.extract-version.outputs.apbs-tag }}
      package-file-lin: ${{ steps.cpack-ml.outputs.package-file-ubuntu-latest }}
      package-file-mac: ${{ steps.cpack-ml.outputs.package-file-macOS-latest }}
      package-file-win: ${{ steps.cpack-w.outputs.package-file-windows-latest }}

    steps:

      - name: Add msbuild to PATH
        if: startsWith(matrix.os, 'windows')  # Windows only
        uses: microsoft/setup-msbuild@v1.0.2

      - name: Checkout reposistory
        uses: actions/checkout@master
        with:
          submodules: recursive

      - name: Extract version
        run: |
          version="$(grep -E '^[0-9]+_[0-9]+_[0-9]+' VERSION | sed 's/_/./g')"
          echo $version
          echo ::set-output name=apbs-version::${version}
          echo ::set-output name=apbs-tag::v${version}
        shell: bash
        id: extract-version

      - name: Set up Python
        uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python-version }}

      - name: Mac Prereqs
        if: startsWith(matrix.os, 'macos')  # Mac only
        run: |
          brew install \
            bison \
            flex \
            swig \
            libomp \
            lapack \
            suite-sparse \
            superlu \
            boost \
            eigen \
            openblas
          brew upgrade gcc@9

      - name: Linux Prereqs and Remove broken apt repos [Ubuntu]
        if: startsWith(matrix.os, 'ubuntu')  # Linux only
        run: |
          for apt_file in `grep -lr microsoft /etc/apt/sources.list.d/`; do sudo rm $apt_file; done
          sudo apt-get install -yq \
            software-properties-common \
            build-essential \
            bison \
            flex \
            swig \
            libreadline-dev \
            libomp5 \
            libomp-dev \
            libsuitesparse-dev \
            libsuperlu-dev \
            libeigen3-dev \
            libboost-dev \
            libopenblas-dev

      - name: Install Window dependencies
        if: startsWith(matrix.os, 'windows')  # Windows only
        run: |
          choco install wget
          wget https://github.com/Electrostatics/cache/releases/download/${WIN_DEPENDENCIES_RELEASE}/apbs_dependencies_vcpkg.zip
          7z x apbs_dependencies_vcpkg.zip -aoa -o/c/vcpkg
          ls /c/vcpkg
          vcpkg integrate install
          vcpkg list --triplet x86-windows
        shell: bash

      - name: Configure for Windows
        if: startsWith(matrix.os, 'windows')  # Windows only
        env:
          CMAKE_PREFIX_PATH: ${VCPKG_INSTALLATION_ROOT}/installed/x86-windows
        run: |
          mkdir -p build/${RELEASE_TYPE}
          cd build
          echo $CMAKE_PREFIX_PATH
          cmake -DCMAKE_TOOLCHAIN_FILE=${WIN_TOOLCHAIN_FILE} -DVCPKG_TARGET_TRIPLET=x86-windows -DCMAKE_INSTALL_INCLUDEDIR=include -DCMAKE_BUILD_TYPE=${RELEASE_TYPE} -DCMAKE_VERBOSE_MAKEFILE:BOOL=OFF -DBUILD_TESTING=${BUILD_TESTING} -DBUILD_TOOLS=${BUILD_TOOLS} -DCHECK_EPSILON=ON -DENABLE_FETK=${ENABLE_FETK} -DENABLE_BEM=${ENABLE_BEM} -DENABLE_GEOFLOW=${ENABLE_GEOFLOW} -DENABLE_iAPBS=${ENABLE_iAPBS} -DENABLE_INLINE=ON -DENABLE_PBAM=${ENABLE_PBAM} -DENABLE_PBSAM=${ENABLE_PBSAM} -DENABLE_PYTHON=${ENABLE_PYTHON} -DENABLE_TESTS=${ENABLE_TESTS} -DBUILD_SHARED_LIBS=${BUILD_SHARED_LIBS} -DENABLE_VERBOSE_DEBUG=OFF -DGET_NanoShaper=${GET_NanoShaper} -DFETK_VERSION=${FETK_VERSION} -DGIT_SUBMODULE=${GIT_SUBMODULE} -G "Visual Studio 16 2019" -A Win32 ..
          cat CMakeCache.txt
        shell: bash

      - name: Configure and Build for Mac
        if: startsWith(matrix.os, 'macos')  # Mac only
        env:
          CMAKE_PREFIX_PATH: /usr/local/opt/openblas
        run: |
          ./.build.sh

      - name: Configure and Build for Linux
        if: startsWith(matrix.os, 'ubuntu')  # Linux only
        run: |
          ./.build.sh
        env:
          # https://codecov.io/gh/Electrostatics/apbs
          CODECOV_TOKEN: "e3a1e24c-5598-4f47-9353-7fa0ac57f98e"

      - name: Build on Windows
        if: startsWith(matrix.os, 'windows')  # Windows only
        run: |
          cd build
          cmake --build . --config Release --parallel 2 --target install

      - name: Run tests
        run: |
          cd build
          ctest -C Release --output-on-failure 

      - name: Create package for Mac and Linux
        if: startsWith(matrix.os, 'macos') || startswith(matrix.os, 'ubuntu') # Mac or Linux only
        id: cpack-ml
        run: |
          cd build
          cpack -C Release -G ZIP
          PACKAGE_FILE=`ls APBS*.zip`
          echo "PACKAGE_FILE=${PACKAGE_FILE}" >> $GITHUB_ENV
          echo ::set-output name=package-file-${{ matrix.os }}::${PACKAGE_FILE}
          echo "Package file: $PACKAGE_FILE"
          unzip -l ${PACKAGE_FILE}

      - name: Create package for Windows
        if: startsWith(matrix.os, 'windows')  # Windows only
        id: cpack-w
        run: |
          cd build
          /c/Program\ Files/CMake/bin/cpack.exe -C Release -G ZIP -V
          PACKAGE_FILE=`ls APBS*.zip`
          echo "PACKAGE_FILE=${PACKAGE_FILE}" >> $GITHUB_ENV
          echo ::set-output name=package-file-${{ matrix.os }}::${PACKAGE_FILE}
          echo "Package file: $PACKAGE_FILE"
          unzip -l ${PACKAGE_FILE}
        shell: bash

      - name: Upload package to the action
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.PACKAGE_FILE }}
          path: build/${{ env.PACKAGE_FILE }}
          retention-days: 5

# For debugging
#      - name: Setup tmate session
#        if: ${{ ! success() }}
#        uses: mxschmitt/action-tmate@v3


  test:
    name: Test Usage

    needs: build

    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macOS-latest, windows-latest]
        include:
          - os: ubuntu-latest
            package_file: ${{ needs.build.outputs.package-file-lin }}
          - os: macOS-latest
            package_file: ${{ needs.build.outputs.package-file-mac }}
          - os: windows-latest
            package_file: ${{ needs.build.outputs.package-file-win }}

    steps:

      - name: Linux Prereqs
        if: startsWith(matrix.os, 'ubuntu')  # Linux only
        run: |
          sudo apt-get install -yq \
            libsuitesparse-dev \
            libsuperlu-dev \
            libopenblas-dev

      - name: Mac Prereqs
        if: startsWith(matrix.os, 'macos')  # Mac only
        run: |
          brew install \
            suite-sparse \
            superlu \
            openblas

      - name: Windows Prereqs
        if: startsWith(matrix.os, 'windows')  # Windows only
        run: |
          choco install wget
          wget https://github.com/Electrostatics/cache/releases/download/${WIN_DEPENDENCIES_RELEASE}/apbs_dependencies_vcpkg.zip
          7z x apbs_dependencies_vcpkg.zip -aoa -o/c/vcpkg
          ls /c/vcpkg
          vcpkg integrate install
          vcpkg list --triplet x86-windows
          echo "/c/vcpkg/installed/x86-windows/bin" >> $GITHUB_PATH
        shell: bash

      - name: Download artifacts
        uses: actions/download-artifact@v2
        with:
          name: ${{ matrix.package_file }}

      - name: Run examples
        run: |
          unzip APBS*.zip
          APBS_DIR=${RUNNER_WORKSPACE}/apbs/$(basename -- "$(ls ${{ matrix.package_file }})" .zip)
          cd ${APBS_DIR}/share/apbs/examples
          ./run_selected_examples.sh
        shell: bash

# For debugging
#      - name: Setup tmate session
#        if: ${{ ! success() }}
#        uses: mxschmitt/action-tmate@v3

 
  release:
    name: Publish Release Artifacts

    needs: [build, test]

    if: startswith(github.ref, 'refs/tags/')  # Tag/release only

    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macOS-latest, windows-latest]
        include:
          - os: ubuntu-latest
            package_file: ${{ needs.build.outputs.package-file-lin }}
          - os: macOS-latest
            package_file: ${{ needs.build.outputs.package-file-mac }}
          - os: windows-latest
            package_file: ${{ needs.build.outputs.package-file-win }}

    steps:

      - name: Download artifacts
        uses: actions/download-artifact@v2
        with:
          name: ${{ matrix.package_file }}

      - name: Release artifacts
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        with:
          files: |
            ${{ matrix.package_file }}
          fail_on_unmatched_files: true
          tag_name: ${{ needs.build.outputs.apbs-tag }}

# For debugging
#      - name: Setup tmate session
#        if: ${{ ! success() }}
#        uses: mxschmitt/action-tmate@v3
